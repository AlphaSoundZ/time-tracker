var f=Object.defineProperty;var w=(n,t,e)=>t in n?f(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var d=(n,t,e)=>(w(n,typeof t!="symbol"?t+"":t,e),e);import{r as k,t as u,s as c,_ as S,a as m,c as h,b as l,F as v,e as y,f as p,i as _,p as D,h as E}from"./index-11b04d1a.js";class g{constructor(t){d(this,"supabase");d(this,"currentTrackingId");this.supabase=t,this.currentTrackingId=null}async add(t,e,r){const a=await this.checkSession();if(!a)return{data:null,error:"User not logged in"};const i=e.toISOString(),s=(r==null?void 0:r.toISOString())||null,{data:o,error:T}=await this.supabase.from("trackings").insert([{title:t,start:i,end:s,user:a==null?void 0:a.id}]);return o&&o.length==1?this.currentTrackingId=o[0].id:this.currentTrackingId=null,{data:o,error:T}}async start(t,e){return await this.add(t,e,null)}async stop(t){const e=await this.checkSession();if(!e)return{data:null,error:"User not logged in"};const r=t.toISOString(),{data:a,error:i}=await this.supabase.from("trackings").select("id").eq("user",e==null?void 0:e.id).is("end",null);if(a&&a.length==1){const{data:s,error:o}=await this.supabase.from("trackings").update({end:r}).eq("id",a[0].id);return s&&s.length==1?this.currentTrackingId=s[0].id:this.currentTrackingId=null,{data:s,error:o}}else return{data:null,error:"No tracking to stop"}}async getCurrentStartTime(){const t=await this.checkSession();if(!t)return{date:null,error:"User not logged in"};const{data:e,error:r}=await this.supabase.from("trackings").select("start").eq("user",t==null?void 0:t.id).is("end",null);return e&&e.length>0?{date:new Date(e[0].start),error:null}:{date:null,error:null}}async getCurrentTracking(){const t=await this.checkSession();if(!t)return{data:null,error:"User not logged in"};const{data:e,error:r}=await this.supabase.from("trackings").select().eq("user",t==null?void 0:t.id).is("end",null);return e&&e.length>0?{data:e[0],error:null}:{data:null,error:null}}async checkSession(){var r;const{data:t,error:e}=await this.supabase.auth.getSession();return t?(r=t.session)==null?void 0:r.user:!1}async update(t,e){var a;if(!await this.checkSession())return{data:null,error:"User not logged in"};if(e=e||this.currentTrackingId||((a=(await this.getCurrentTracking()).data)==null?void 0:a.id),e){const{data:i,error:s}=await this.supabase.from("trackings").update(t).eq("id",e);return{data:i,error:s}}else return{data:null,error:"No tracking to update"}}async getTitles(){const t=await this.checkSession();if(!t)return{data:null,error:"User not logged in"};const{data:e,error:r}=await this.supabase.from("titles").select("title, amount, last_use").eq("user",t==null?void 0:t.id);return e&&e.length>0?{data:e,error:null}:{data:null,error:null}}}let b=null,B=null;const C={name:"TrackView",data(){return{trackingTime:"",intervalId:b,autocompletionItems:k([])}},methods:{async toggleTracking(){u.show(),document.getElementById("trackingToggle"),this.isIntervalRunning()?this.stopTracking().then(()=>{u.hide()}):this.startTracking().then(()=>{u.hide()})},async startTracking(){const n=new Date,t=new g(c),e=document.getElementById("trackingToggle"),r=document.getElementById("titleInput");this.startInterval(n),e.innerHTML="Stop Tracking",await t.start(r.value,n).then(a=>{a.error?(console.log(a.error),e.innerHTML="Start Tracking",this.stopInterval(),this.trackingTime="--:--:--"):console.log("tracking started!")})},async stopTracking(){const n=new Date,t=new g(c),e=document.getElementById("trackingToggle"),r=document.getElementById("titleInput");this.stopInterval(),this.trackingTime="00:00:00",r.value="",sessionStorage.removeItem("trackingTitle"),e.innerHTML="Start Tracking",await t.stop(n).then(a=>{a.error&&console.log(a.error),this.fetchAutocompletionItems(),console.log("tracking stopped!")})},async updateTracking(n){var o;const t=new g(c),{data:e,error:r}=await t.getCurrentTracking(),a=e!=null&&e.start?new Date(e.start):null;if(r){console.log(r);return}const i=document.getElementById("trackingToggle"),s=document.getElementById("titleInput");a&&!this.isIntervalRunning()?(console.log("tracking has changed to running"),this.startInterval(a),i.innerHTML="Stop Tracking"):!a&&this.isIntervalRunning()&&(console.log("tracking has changed to stopped"),this.trackingTime="00:00:00",s.value="",sessionStorage.removeItem("trackingTitle"),this.stopInterval(),i.innerHTML="Start Tracking"),this.isIntervalRunning()?(s.value=((o=n.title)==null?void 0:o.toString())||"",sessionStorage.setItem("trackingTitle",s.value)):s.value=sessionStorage.getItem("trackingTitle")||""},startInterval(n){const e=new Date().getTime()-n.getTime(),r=new Date(e);this.trackingTime=this.formatDate(r),this.intervalId=setInterval(()=>{const i=new Date().getTime()-n.getTime(),s=new Date(i);this.trackingTime=this.formatDate(s)},1e3)},stopInterval(){clearInterval(this.intervalId),this.intervalId=null},isIntervalRunning(){return this.intervalId!=null},formatDate(n){const t=n.getUTCHours().toString().padStart(2,"0"),e=n.getUTCMinutes().toString().padStart(2,"0"),r=n.getUTCSeconds().toString().padStart(2,"0");return`${t}:${e}:${r}`},async updateTitle(){const n=document.getElementById("titleInput"),t=new g(c);sessionStorage.setItem("trackingTitle",n.value),this.isIntervalRunning()&&await t.update({title:n.value},null)},async updateAutocompletion(){const n=document.getElementById("titleInput");sessionStorage.getItem("autocompletionItems")||await this.fetchAutocompletionItems();const t=n.value.toLowerCase(),e=JSON.parse(sessionStorage.getItem("autocompletionItems")||"[]");if(n.value.length==0){this.autocompletionItems=e.slice(0,1);return}const r=e.filter(a=>a.title.toLowerCase().includes(t));r.sort((a,i)=>i.amount-a.amount),this.autocompletionItems=r.slice(0,3)},selectAutocompleteItem(n){const t=document.getElementById("titleInput"),e=n.title;t.value=e,this.updateTitle(),this.autocompletionItems=[]},async fetchAutocompletionItems(){const t=await new g(c).getTitles();if(t.error){console.log(t.error);return}sessionStorage.setItem("autocompletionItems",JSON.stringify(t.data))}},setup(){const n=k("--:--:--");return u.show(),{trackingTime:n}},async mounted(){const n=new g(c);await n.getCurrentTracking().then(t=>{var r;const e=(r=t.data)!=null&&r.start?new Date(t.data.start):null;if(t.error){console.log(t.error),u.hide();return}e||(this.trackingTime="00:00:00"),this.updateTracking(t.data)}),await n.getTitles().then(t=>{if(t.error){console.log(t.error);return}sessionStorage.setItem("autocompletionItems",JSON.stringify(t.data))}),document.addEventListener("click",t=>{const e=document.getElementById("titleInput");t.target!=e&&(this.autocompletionItems=[])}),B=c.channel("public:trackings").on("postgres_changes",{event:"*",schema:"public",table:"trackings"},async t=>{this.updateTracking(t.new)}).subscribe(),u.hide()}};const I=n=>(D("data-v-ee96f85d"),n=n(),E(),n),A=I(()=>l("h1",{class:"title"},"Current Tracking",-1)),L={class:"tracking-container"},U={class:"autocomplete"},R={class:"tracking-title-container"},N={class:"autocomplete-items"},q=["onClick"],x=I(()=>l("br",null,null,-1)),H={style:{"font-size":"small"}},M={class:"tracking-time",id:"trackingTime"};function O(n,t,e,r,a,i){return m(),h("main",null,[A,l("div",L,[l("div",U,[l("div",R,[l("input",{autocomplete:"off",class:"tracking-title",type:"text",placeholder:"Title",id:"titleInput",onChange:t[0]||(t[0]=(...s)=>i.updateTitle&&i.updateTitle(...s)),onFocusin:t[1]||(t[1]=(...s)=>i.updateAutocompletion&&i.updateAutocompletion(...s)),onKeyup:t[2]||(t[2]=(...s)=>i.updateAutocompletion&&i.updateAutocompletion(...s))},null,32)]),l("div",N,[(m(!0),h(v,null,y(a.autocompletionItems,s=>(m(),h("div",{onClick:o=>i.selectAutocompleteItem(s)},[_(p(s.title)+" ",1),x,l("p",H,p(new Date(s.last_use).toLocaleDateString()),1)],8,q))),256))])]),l("h3",M,p(r.trackingTime),1)]),l("a",{id:"trackingToggle",class:"button is-primary",href:"#",onClick:t[3]||(t[3]=(...s)=>i.toggleTracking&&i.toggleTracking(...s))},"Start Tracking")])}const J=S(C,[["render",O],["__scopeId","data-v-ee96f85d"]]);export{J as default};
