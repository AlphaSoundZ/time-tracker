var T=Object.defineProperty;var p=(n,t,e)=>t in n?T(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var d=(n,t,e)=>(p(n,typeof t!="symbol"?t+"":t,e),e);import{t as c,r as m,s as l,_ as f,a as I,c as w,b as g,f as S,p as v,h as _}from"./index-930b7edf.js";class u{constructor(t){d(this,"supabase");d(this,"currentTrackingId");this.supabase=t,this.currentTrackingId=null}async add(t,e,r){const a=await this.checkSession();if(!a)return{data:null,error:"User not logged in"};const i=e.toISOString(),s=(r==null?void 0:r.toISOString())||null,{data:o,error:k}=await this.supabase.from("trackings").insert([{title:t,start:i,end:s,user:a==null?void 0:a.id}]);return o&&o.length==1?this.currentTrackingId=o[0].id:this.currentTrackingId=null,{data:o,error:k}}async start(t,e){return await this.add(t,e,null)}async stop(t){const e=await this.checkSession();if(!e)return{data:null,error:"User not logged in"};const r=t.toISOString(),{data:a,error:i}=await this.supabase.from("trackings").select("id").eq("user",e==null?void 0:e.id).is("end",null);if(a&&a.length==1){const{data:s,error:o}=await this.supabase.from("trackings").update({end:r}).eq("id",a[0].id);return s&&s.length==1?this.currentTrackingId=s[0].id:this.currentTrackingId=null,{data:s,error:o}}else return{data:null,error:"No tracking to stop"}}async getCurrentStartTime(){const t=await this.checkSession();if(!t)return{date:null,error:"User not logged in"};const{data:e,error:r}=await this.supabase.from("trackings").select("start").eq("user",t==null?void 0:t.id).is("end",null);return e&&e.length>0?{date:new Date(e[0].start),error:null}:{date:null,error:null}}async checkSession(){var r;const{data:t,error:e}=await this.supabase.auth.getSession();return t?(r=t.session)==null?void 0:r.user:!1}}let y=null,b=null;const D={name:"TrackView",data(){return{trackingTime:"",intervalId:y}},methods:{async toggleTracking(){c.show(),document.getElementById("trackingToggle"),this.isIntervalRunning()?this.stopTracking().then(()=>{c.hide()}):this.startTracking().then(()=>{c.hide()})},async startTracking(){const n=new Date,t=new u(l),e=document.getElementById("trackingToggle");this.startInterval(n),e.innerHTML="Stop Tracking",await t.start("tracking!",n).then(r=>{r.error?(console.log(r.error),e.innerHTML="Start Tracking",this.stopInterval()):console.log("tracking started!")})},async stopTracking(){const n=new Date,t=new u(l),e=document.getElementById("trackingToggle");this.stopInterval(),this.trackingTime="00:00:00",e.innerHTML="Start Tracking",await t.stop(n).then(r=>{r.error&&console.log(r.error),console.log("tracking stopped!")})},async updateTracking(){const n=new u(l),{date:t,error:e}=await n.getCurrentStartTime();if(e){console.log(e);return}const r=document.getElementById("trackingToggle");t&&!this.isIntervalRunning()?(this.startInterval(t),r.innerHTML="Stop Tracking"):!t&&this.isIntervalRunning()&&(this.trackingTime="00:00:00",this.stopInterval(),r.innerHTML="Start Tracking")},startInterval(n){const e=new Date().getTime()-n.getTime(),r=new Date(e);this.trackingTime=this.formatDate(r),this.intervalId=setInterval(()=>{const i=new Date().getTime()-n.getTime(),s=new Date(i);this.trackingTime=this.formatDate(s)},1e3)},stopInterval(){clearInterval(this.intervalId),this.intervalId=null},isIntervalRunning(){return this.intervalId!=null},formatDate(n){const t=n.getUTCHours().toString().padStart(2,"0"),e=n.getUTCMinutes().toString().padStart(2,"0"),r=n.getUTCSeconds().toString().padStart(2,"0");return`${t}:${e}:${r}`}},setup(){const n=m("--:--:--");return c.show(),{trackingTime:n}},async mounted(){const n=new u(l),{date:t,error:e}=await n.getCurrentStartTime();if(e){console.log(e),c.hide();return}if(t){this.startInterval(t);const r=document.getElementById("trackingToggle");r.innerHTML="Stop Tracking"}else this.trackingTime="00:00:00";b=l.channel("public:trackings").on("postgres_changes",{event:"*",schema:"public",table:"trackings"},async r=>{this.updateTracking()}).subscribe(),c.hide()}};const h=n=>(v("data-v-75aecded"),n=n(),_(),n),B=h(()=>g("h1",{class:"title"},"Current Tracking",-1)),E={id:"trackingTime"},C=h(()=>g("br",null,null,-1));function H(n,t,e,r,a,i){return I(),w("main",null,[B,g("div",null,[g("h3",E,S(r.trackingTime),1)]),C,g("a",{id:"trackingToggle",class:"button is-primary",href:"#",onClick:t[0]||(t[0]=(...s)=>i.toggleTracking&&i.toggleTracking(...s))},"Start Tracking")])}const R=f(D,[["render",H],["__scopeId","data-v-75aecded"]]);export{R as default};
