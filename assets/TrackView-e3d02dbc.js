var h=Object.defineProperty;var p=(n,t,e)=>t in n?h(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var d=(n,t,e)=>(p(n,typeof t!="symbol"?t+"":t,e),e);import{t as c,r as T,s as l,_ as m,a as I,c as f,b as g,f as w,p as v,h as S}from"./index-52c7c8d6.js";class u{constructor(t){d(this,"supabase");d(this,"currentTrackingId");this.supabase=t,this.currentTrackingId=null}async add(t,e,r){const a=await this.checkSession();if(!a)return{data:null,error:"User not logged in"};const i=e.toISOString(),s=(r==null?void 0:r.toISOString())||null,{data:o,error:k}=await this.supabase.from("trackings").insert([{title:t,start:i,end:s,user:a==null?void 0:a.id}]);return o&&o.length==1?this.currentTrackingId=o[0].id:this.currentTrackingId=null,{data:o,error:k}}async start(t,e){return await this.add(t,e,null)}async stop(t){const e=await this.checkSession();if(!e)return{data:null,error:"User not logged in"};const r=t.toISOString(),{data:a,error:i}=await this.supabase.from("trackings").select("id").eq("user",e==null?void 0:e.id).is("end",null);if(a&&a.length==1){const{data:s,error:o}=await this.supabase.from("trackings").update({end:r}).eq("id",a[0].id);return s&&s.length==1?this.currentTrackingId=s[0].id:this.currentTrackingId=null,{data:s,error:o}}else return{data:null,error:"No tracking to stop"}}async getCurrentStartTime(){const t=await this.checkSession();if(!t)return{date:null,error:"User not logged in"};const{data:e,error:r}=await this.supabase.from("trackings").select("start").eq("user",t==null?void 0:t.id).is("end",null);return e&&e.length>0?{date:new Date(e[0].start),error:null}:{date:null,error:null}}async getCurrentTracking(){const t=await this.checkSession();if(!t)return{data:null,error:"User not logged in"};const{data:e,error:r}=await this.supabase.from("trackings").select().eq("user",t==null?void 0:t.id).is("end",null);return e&&e.length>0?{data:e[0],error:null}:{data:null,error:null}}async checkSession(){var r;const{data:t,error:e}=await this.supabase.auth.getSession();return t?(r=t.session)==null?void 0:r.user:!1}async update(t,e){var a;if(!await this.checkSession())return{data:null,error:"User not logged in"};if(e=e||this.currentTrackingId||((a=(await this.getCurrentTracking()).data)==null?void 0:a.id),e){const{data:i,error:s}=await this.supabase.from("trackings").update(t).eq("id",e);return{data:i,error:s}}else return{data:null,error:"No tracking to update"}}}let y=null,_=null;const b={name:"TrackView",data(){return{trackingTime:"",intervalId:y}},methods:{async toggleTracking(){c.show(),document.getElementById("trackingToggle"),this.isIntervalRunning()?this.stopTracking().then(()=>{c.hide()}):this.startTracking().then(()=>{c.hide()})},async startTracking(){const n=new Date,t=new u(l),e=document.getElementById("trackingToggle"),r=document.getElementById("titleInput");this.startInterval(n),e.innerHTML="Stop Tracking",await t.start(r.value,n).then(a=>{a.error?(console.log(a.error),e.innerHTML="Start Tracking",this.stopInterval(),this.trackingTime="--:--:--"):console.log("tracking started!")})},async stopTracking(){const n=new Date,t=new u(l),e=document.getElementById("trackingToggle"),r=document.getElementById("titleInput");this.stopInterval(),this.trackingTime="00:00:00",r.value="",sessionStorage.removeItem("trackingTitle"),e.innerHTML="Start Tracking",await t.stop(n).then(a=>{a.error&&console.log(a.error),console.log("tracking stopped!")})},async updateTracking(n){var o;const t=new u(l),{data:e,error:r}=await t.getCurrentTracking(),a=e!=null&&e.start?new Date(e.start):null;if(r){console.log(r);return}const i=document.getElementById("trackingToggle"),s=document.getElementById("titleInput");a&&!this.isIntervalRunning()?(console.log("tracking has changed to running"),this.startInterval(a),i.innerHTML="Stop Tracking"):!a&&this.isIntervalRunning()&&(console.log("tracking has changed to stopped"),this.trackingTime="00:00:00",s.value="",sessionStorage.removeItem("trackingTitle"),this.stopInterval(),i.innerHTML="Start Tracking"),this.isIntervalRunning()?(s.value=((o=n.title)==null?void 0:o.toString())||"",sessionStorage.setItem("trackingTitle",s.value)):s.value=sessionStorage.getItem("trackingTitle")||""},startInterval(n){const e=new Date().getTime()-n.getTime(),r=new Date(e);this.trackingTime=this.formatDate(r),this.intervalId=setInterval(()=>{const i=new Date().getTime()-n.getTime(),s=new Date(i);this.trackingTime=this.formatDate(s)},1e3)},stopInterval(){clearInterval(this.intervalId),this.intervalId=null},isIntervalRunning(){return this.intervalId!=null},formatDate(n){const t=n.getUTCHours().toString().padStart(2,"0"),e=n.getUTCMinutes().toString().padStart(2,"0"),r=n.getUTCSeconds().toString().padStart(2,"0");return`${t}:${e}:${r}`},async updateTitle(){const n=document.getElementById("titleInput"),t=new u(l);sessionStorage.setItem("trackingTitle",n.value),await t.update({title:n.value},null)}},setup(){const n=T("--:--:--");return c.show(),{trackingTime:n}},async mounted(){const n=new u(l),{data:t,error:e}=await n.getCurrentTracking(),r=t!=null&&t.start?new Date(t.start):null;if(e){console.log(e),c.hide();return}r||(this.trackingTime="00:00:00"),this.updateTracking(t),_=l.channel("public:trackings").on("postgres_changes",{event:"*",schema:"public",table:"trackings"},async a=>{this.updateTracking(a.new)}).subscribe(),c.hide()}};const D=n=>(v("data-v-81954bc6"),n=n(),S(),n),E=D(()=>g("h1",{class:"title"},"Current Tracking",-1)),B={class:"tracking-container"},C={class:"tracking-title-container"},U={class:"tracking-time",id:"trackingTime"};function R(n,t,e,r,a,i){return I(),f("main",null,[E,g("div",B,[g("div",C,[g("input",{class:"tracking-title",type:"text",placeholder:"Title",id:"titleInput",onChange:t[0]||(t[0]=(...s)=>i.updateTitle&&i.updateTitle(...s))},null,32)]),g("h3",U,w(r.trackingTime),1)]),g("a",{id:"trackingToggle",class:"button is-primary",href:"#",onClick:t[1]||(t[1]=(...s)=>i.toggleTracking&&i.toggleTracking(...s))},"Start Tracking")])}const q=m(b,[["render",R],["__scopeId","data-v-81954bc6"]]);export{q as default};
